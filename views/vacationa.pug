extends layout
block content
 mixin ddl(year)
  for t in year
   option(value=t selected=(parms.thisyear == t ? true : false))=t
 mixin tbody(tbl)
  tbody
   -var i=0
   while i<tbl
    tr#editline(class=i+1)
     td=i+1
     td=parms.vlist[i].dtitle
     td=parms.vlist[i].doffice
     td=parms.vlist[i++].dsite
     td
      a.delete.fa.fa-trash
 .container     
  h2(style="margin:0 0 15px 15px")='ตั้งค่าวันหยุดประจำปี'
   select.tyear(style="margin-left: 35px; font-size: 16px")
    +ddl(parms.yearlist)
  span.col.col-lg-2
   input.ava(type="text" placeholder="Title...")
   span.addBtn='เพิ่ม'
   .input-group.date
    input.form-control.datepickera(type='text' readonly placeholder="วันหยุดออฟฟิส...")
    .input-group-addon.picka
     span.fa.fa-building
   .input-group.date
    input.form-control.datepickerb(type='text' readonly placeholder="วันหยุดหน้างาน...")
    .input-group-addon.pickb
     span.fa.fa-home
  span.col.col-lg-10
   table.table
    thead
     tr
      td.col.col-sm-1="ลำดับ"
      td.col.col-sm-3="วันสำคัญ"
      td.col.col-sm-3="วันหยุดออฟฟิส"
      td.col.col-sm-3="วันหยุดหน้างาน"
      td.col.col-sm-1
    +tbody(parms.tbl)
 style.
  .ava {
    margin: 0 0 5px 0; 
    width: 181px;
    position:relative;
  }
  .addBtn {
    padding: 8px 8px 8px 8px;
    margin: 0 0 0 5px;
    cursor: pointer;
    background-color: #b5daf9;
    align:center;
  }
  tr#editline:hover {
    cursor: pointer;
    background-color: #dfdce9;
  }
  table.table td a.delete {
    display: inline-block;
    color: #E34724;
  }
 script.
  $(document).ready(function(){
    $('.tyear').change(function () {
      $(this).find('option[selected]').removeAttr('selected')
      $(this).find('option[value='+$(this).val()+']').attr('selected','')
      $.ajax({
          url: '/vacationa',
          type: "POST",
          dataType: 'json',
          async: false,
          data: {
            state: 'refresh',
            dyear: $(this).val()
          },
          success: function (data) {
            $('tbody tr').remove()
            var i=0,addElement
            while (i < data.tbl) {
              addElement += '<tr class=list'+(i+1)+'>\
              <td>'+(i+1)+'</td>\
              <td>'+data.vlist[i].dtitle+'</td>\
              <td>'+data.vlist[i].doffice+'</td>\
              <td>'+data.vlist[i].dsite+'</td>\
              </tr>'
              i++
            }
            $('table').append(addElement)
          }
        })
    })
    $('.datepickera').datepicker({
      ignoreReadonly: true,
      format: 'dd/MM/yyyy',
      todayHighlight: true,
      clearBtn: true
    })
    $('.datepickerb').datepicker({
      ignoreReadonly: true,
      format: 'dd/MM/yyyy',
      todayHighlight: true,
      clearBtn: true
    })
    $('.datepickera').datepicker().on('changeDate',function(e) {
      if ($('.datepickera').datepicker('getDate')) {
        $('.datepickera').datepicker('hide')
        $('.datepickerb').datepicker('setDate',$('.datepickera').datepicker('getDate'))
        $('.datepickerb').datepicker('show')
      } else {
        $('.datepickera').datepicker('hide')
        $('.datepickerb').datepicker('show')
      }
    })
    $('.datepickerb').datepicker().on('changeDate',function(e) {
      $('.datepickerb').datepicker('hide')
    })
    $(document).on("click", ".picka", function() {
      $('.datepickera').datepicker('show')
    })
    $(document).on("click", ".pickb", function() {
      $('.datepickerb').datepicker('show')
    })
    $('.delete').click(function () {
      $.ajax({
          url: '/vacationa',
          type: "POST",
          dataType: 'json',
          async: false,
          data: {
            state: 'remove',
            dtitle: dtitle,
            doffice: (doffice=="" ? 0 : doffice),
            dsite: (dsite=="" ? 0 : dsite),
            dyear: dyear
          },
          success: function (data) {
            $(this).parents('tr').remove()
          }
      })
    })
    $(document).on("click", ".addBtn", function() {
     var dtitle = $('.ava').val(),
      doffice = ($('.datepickera').datepicker('getDate') ? $('.datepickera').datepicker('getDate').getTime() : 0),
      dsite = ($('.datepickerb').datepicker('getDate') ? $('.datepickerb').datepicker('getDate').getTime() : 0),
      lastline = parseInt($('tbody').find('tr:last-child').find('td:first-child').text())+1,
      dyear = $('.tyear').val(),
      addElement
      if (dtitle && dyear && (doffice || dsite)) {
        $.ajax({
          url: '/vacationa',
          type: "POST",
          dataType: 'json',
          async: false,
          data: {
            state: 'add',
            dtitle: dtitle,
            doffice: doffice,
            dsite: dsite,
            lastline: lastline,
            dyear: dyear
          },
          success: function (data) {
            addElement = '<tr class=list'+data.lastline+'>\
            <td>'+data.lastline+'</td>\
            <td>'+data.dtitle+'</td>\
            <td>'+data.doffice+'</td>\
            <td>'+data.dsite+'</td>\
            </tr>'
            $('tbody').append(addElement)
          }
        })
      }
    })
  })
 script(src="js/bootstrap-datepicker.min.js")
 script(src="js/moment.min.js")
 link(rel='stylesheet' , href='css/bootstrap-datepicker.min.css')
